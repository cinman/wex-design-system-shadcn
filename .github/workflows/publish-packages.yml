name: Publish Packages

on:
  workflow_dispatch:  # Manual trigger
  push:  # Runs on any push to any branch
  # pull_request:
  #   branches:
  #     - main

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      tokens-changed: ${{ steps.filter-tokens.outputs.changed }}
      components-changed: ${{ steps.filter-components.outputs.changed }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Use Node.js Version 22
        uses: actions/setup-node@v4
        with:
          node-version: 22
      
      - name: Generate Runtime Configuration File
        run: |
          rm -rf .npmrc
          echo "registry=https://registry.npmjs.org/" > .npmrc
          echo "@wex:registry=https://usartifactorywexinc.jfrog.io/artifactory/api/npm/wex-npm-prod" >> .npmrc
          echo "//usartifactorywexinc.jfrog.io/artifactory/api/npm/wex-npm-prod/:_authToken=${{ secrets.ARTIFACTORY_TOKEN }}" >> .npmrc
          echo "//usartifactorywexinc.jfrog.io/artifactory/api/npm/wex-npm-prod/:always-auth=true" >> .npmrc
      
      - name: Check if tokens version has changed
        id: filter-tokens
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            LOCAL_VERSION=$(node -p "require('./packages/design-tokens/package.json').version")
            echo "Local tokens version: $LOCAL_VERSION"
            PUBLISHED_VERSION=$(npm view @wex/design-tokens version --registry=https://usartifactorywexinc.jfrog.io/artifactory/api/npm/wex-npm-prod 2>/dev/null || echo "")
            if [ -z "$PUBLISHED_VERSION" ]; then
              echo "Tokens package not found in Artifactory - will publish"
              echo "changed=true" >> $GITHUB_OUTPUT
            elif [ "$LOCAL_VERSION" != "$PUBLISHED_VERSION" ]; then
              echo "Tokens version changed: $PUBLISHED_VERSION -> $LOCAL_VERSION"
              echo "changed=true" >> $GITHUB_OUTPUT
            else
              echo "Tokens version unchanged: $LOCAL_VERSION (already published)"
              echo "changed=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Check if components version has changed
        id: filter-components
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            LOCAL_VERSION=$(node -p "require('./packages/wex-components/package.json').version")
            echo "Local components version: $LOCAL_VERSION"
            PUBLISHED_VERSION=$(npm view @wex/components version --registry=https://usartifactorywexinc.jfrog.io/artifactory/api/npm/wex-npm-prod 2>/dev/null || echo "")
            if [ -z "$PUBLISHED_VERSION" ]; then
              echo "Components package not found in Artifactory - will publish"
              echo "changed=true" >> $GITHUB_OUTPUT
            elif [ "$LOCAL_VERSION" != "$PUBLISHED_VERSION" ]; then
              echo "Components version changed: $PUBLISHED_VERSION -> $LOCAL_VERSION"
              echo "changed=true" >> $GITHUB_OUTPUT
            else
              echo "Components version unchanged: $LOCAL_VERSION (already published)"
              echo "changed=false" >> $GITHUB_OUTPUT
            fi
          fi

  publish-tokens:
    needs: check-changes
    if: needs.check-changes.outputs.tokens-changed == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}

      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v3
        with:
          version: latest

      - name: Configure JFrog CLI
        run: |
          jf c add --artifactory-url=https://usartifactorywexinc.jfrog.io/artifactory \
            --access-token=${{ secrets.ARTIFACTORY_TOKEN }} \
            --interactive=false \
            server-id
          jf c use server-id

      - name: Configure JFrog npm
        working-directory: packages/design-tokens
        run: |
          jf c use server-id
          jf npm-config --repo-resolve=wex-npm-prod --repo-deploy=wex-npm-subprod --server-id-resolve=server-id --server-id-deploy=server-id

      - name: Use Node.js Version 22
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install Dependencies
        run: npm ci

      - name: Generate Runtime Configuration File
        run: |
          rm -rf .npmrc
          echo "registry=https://registry.npmjs.org/" > .npmrc
          echo "@wex:registry=https://usartifactorywexinc.jfrog.io/artifactory/api/npm/wex-npm-prod" >> .npmrc
          echo "//usartifactorywexinc.jfrog.io/artifactory/api/npm/wex-npm-prod/:_authToken=${{ secrets.ARTIFACTORY_TOKEN }}" >> .npmrc
          echo "//usartifactorywexinc.jfrog.io/artifactory/api/npm/wex-npm-prod/:always-auth=true" >> .npmrc

      - name: Build Design Tokens
        run: node scripts/build-tokens.cjs

      - name: Get Package Version
        id: package
        run: echo "version=$(node -p "require('./packages/design-tokens/package.json').version")" >> $GITHUB_OUTPUT

      - name: Publish to Artifactory (Subprod)
        working-directory: packages/design-tokens
        run: |
          jf npm publish --build-name=${{ github.event.repository.name }} --build-number=${{ github.run_number }}
          jf rt bp "${{ github.event.repository.name }}" "${{ github.run_number }}"

      - name: Promote from Subprod to Production
        run: |
          jf rt bpr \
            --status=promoted \
            --comment="Promoting build ${{ github.run_number }} from subprod to production" \
            "${{ github.event.repository.name }}" \
            "${{ github.run_number }}" \
            "wex-npm-prod" \
            "wex-npm-subprod"

  publish-components:
    needs: check-changes
    if: needs.check-changes.outputs.components-changed == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}

      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v3
        with:
          version: latest

      - name: Configure JFrog CLI
        run: |
          jf c add --artifactory-url=https://usartifactorywexinc.jfrog.io/artifactory \
            --access-token=${{ secrets.ARTIFACTORY_TOKEN }} \
            --interactive=false \
            server-id
          jf c use server-id

      - name: Configure JFrog npm
        working-directory: packages/wex-components
        run: |
          jf c use server-id
          jf npm-config --repo-resolve=wex-npm-prod --repo-deploy=wex-npm-subprod --server-id-resolve=server-id --server-id-deploy=server-id

      - name: Use Node.js Version 22
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install Dependencies
        run: npm ci

      - name: Generate Runtime Configuration File
        run: |
          rm -rf .npmrc
          echo "registry=https://registry.npmjs.org/" > .npmrc
          echo "@wex:registry=https://usartifactorywexinc.jfrog.io/artifactory/api/npm/wex-npm-prod" >> .npmrc
          echo "//usartifactorywexinc.jfrog.io/artifactory/api/npm/wex-npm-prod/:_authToken=${{ secrets.ARTIFACTORY_TOKEN }}" >> .npmrc
          echo "//usartifactorywexinc.jfrog.io/artifactory/api/npm/wex-npm-prod/:always-auth=true" >> .npmrc

      - name: Build Design Tokens
        run: node scripts/build-tokens.cjs

      - name: Build Components Package
        working-directory: packages/wex-components
        run: npm run build

      - name: Get Package Version
        id: package
        run: echo "version=$(node -p "require('./packages/wex-components/package.json').version")" >> $GITHUB_OUTPUT

      - name: Publish to Artifactory (Subprod)
        working-directory: packages/wex-components
        run: |
          jf npm publish --build-name=${{ github.event.repository.name }} --build-number=${{ github.run_number }}
          jf rt bp "${{ github.event.repository.name }}" "${{ github.run_number }}"

      - name: Promote from Subprod to Production
        run: |
          jf rt bpr \
            --status=promoted \
            --comment="Promoting build ${{ github.run_number }} from subprod to production" \
            "${{ github.event.repository.name }}" \
            "${{ github.run_number }}" \
            "wex-npm-prod" \
            "wex-npm-subprod"

