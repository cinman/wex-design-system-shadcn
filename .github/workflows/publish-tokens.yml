name: Publish Design Tokens

on:
  workflow_dispatch:  # Manual trigger
  push:  # Runs on any push to any branch
  # pull_request:
  #   branches:
  #     - main

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.filter.outputs.changed }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Use Node.js Version 22
        uses: actions/setup-node@v4
        with:
          node-version: 22
      
      - name: Generate Runtime Configuration File
        run: |
          rm -rf .npmrc
          echo "registry=https://registry.npmjs.org/" > .npmrc
          echo "@wex:registry=https://artifactory.wexinc.com/artifactory/api/npm/npm-local/" >> .npmrc
          echo "//artifactory.wexinc.com/artifactory/api/npm/npm-local/:_authToken=${{ secrets.ARTIFACTORY_TOKEN }}" >> .npmrc
          echo "//artifactory.wexinc.com/artifactory/api/npm/npm-local/:always-auth=true" >> .npmrc
      
      - name: Check if version has changed
        id: filter
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # For manual runs, always allow (user explicitly triggered)
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            # Get local version from package.json
            LOCAL_VERSION=$(node -p "require('./packages/design-tokens/package.json').version")
            echo "Local version: $LOCAL_VERSION"
            
            # Try to get published version from Artifactory
            # If package doesn't exist yet, npm view will fail - that's okay, we'll publish
            PUBLISHED_VERSION=$(npm view @wex/design-tokens version --registry=https://artifactory.wexinc.com/artifactory/api/npm/npm-local/ 2>/dev/null || echo "")
            
            if [ -z "$PUBLISHED_VERSION" ]; then
              echo "Package not found in Artifactory - will publish"
              echo "changed=true" >> $GITHUB_OUTPUT
            elif [ "$LOCAL_VERSION" != "$PUBLISHED_VERSION" ]; then
              echo "Version changed: $PUBLISHED_VERSION -> $LOCAL_VERSION"
              echo "changed=true" >> $GITHUB_OUTPUT
            else
              echo "Version unchanged: $LOCAL_VERSION (already published)"
              echo "changed=false" >> $GITHUB_OUTPUT
            fi
          fi

  publish-tokens:
    needs: check-changes
    if: needs.check-changes.outputs.changed == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}

      - name: Use Node.js Version 22
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install Dependencies
        run: npm ci

      - name: Generate Runtime Configuration File
        run: |
          rm -rf .npmrc
          echo "registry=https://registry.npmjs.org/" > .npmrc
          echo "@wex:registry=https://artifactory.wexinc.com/artifactory/api/npm/npm-local/" >> .npmrc
          echo "//artifactory.wexinc.com/artifactory/api/npm/npm-local/:_authToken=${{ secrets.ARTIFACTORY_TOKEN }}" >> .npmrc
          echo "//artifactory.wexinc.com/artifactory/api/npm/npm-local/:always-auth=true" >> .npmrc

      - name: Build Design Tokens
        run: node scripts/build-tokens.cjs

      - name: Get Package Version
        id: package
        run: echo "version=$(node -p "require('./packages/design-tokens/package.json').version")" >> $GITHUB_OUTPUT

      - name: Publish to Artifactory
        working-directory: packages/design-tokens
        run: |
          jf npm publish --build-name=${{ github.event.repository.name }} --build-number=${{ github.run_number }}
          jf rt bp "${{ github.event.repository.name }}" "${{ github.run_number }}"

      - name: Promote the Release to Production
        run: |
          jf rt bpr \
            --status=promoted \
            --comment="Promoting build ${{ github.run_number }} to production" \
            "${{ github.event.repository.name }}" \
            "${{ github.run_number }}" \
            "wex-npm-prod"

      - name: Create GitHub Release
        if: github.event_name == 'push'
        uses: actions/create-release@v1
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        with:
          tag_name: "v${{ steps.package.outputs.version }}"
          release_name: Design Tokens Version ${{ steps.package.outputs.version }}
          draft: false
          prerelease: false
